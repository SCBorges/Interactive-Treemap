<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tree Map Project</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <!-- // <script src="jquery-1.11.3.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"> -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <style>

      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: auto;
        position: relative;
        /*width: 960px;*/
        width:100%;
        overflow: hidden;
      }

      form {
        position: absolute;
        right: 10px;
        top: 10px;
      }

      .node {
        border: solid 1px white;
        font: 10px sans-serif;
        line-height: 12px;
        overflow: hidden;
        position: absolute;
        text-indent: 2px;
      }

      svg{
          /*display:block;
        margin:auto;
        box-shadow: 0 2px 7px #AAA;*/
        position:absolute;
        overflow: visible;
      }

    </style>
  </head>
<body>
  <!-- <form>
    <label><input type="radio" name="mode" value="size" checked> Size</label>
    <label><input type="radio" name="mode" value="count"> Count</label>
  </form> -->
  <div id="sidePanel" style="float:right; width:25%; height:100vh; margin:auto; padding:0.75%; background-color:#fff;">
    <div class="panel panel-default">
      <div class="panel-heading"><h4>Information Panel:</h4></div>
      <!-- <div class="panel-body"><i>Node</i></div> -->
      <ul id="selInfo"class="list-group">
        <li id="infoName" class="list-group-item">Name:</li>
        <li id="infoSize" class="list-group-item">Size:</li>
        <li id="infoParent" class="list-group-item">Parent:</li>
      </ul>
    </div>
    <!-- <input type="range" name="input" min="0" max+"100" value="min + (max-min)/2" step="10"/> -->
  </div>
  <div id="main" style="float:left; width:75%; height:100%; margin:auto;"></div>
  <svg id="svgLayer", style="width:1px; height: 1px; position: absolute; overflow:visible; top:1px; left:1px; "></svg>
  
</body>
<script>
var maxDepth = 0;

var margin = {top: 120, right: 40, bottom: 100, left: 100},
    width = document.getElementById("main").offsetWidth - margin.left - margin.right,
    height = window.innerHeight - margin.top - margin.bottom;
    // width = window.innerWidth - margin.left - margin.right,
    // height = window.innerHeight - margin.top - margin.bottom;

var treemap = d3.layout.treemap()
    .size([width, height])
    .sticky(true)
    // .padding(12)
    // .mode("slice-dice")
    .value(function(d) { return d.size; });

var color = d3.scale.category20c();

var div = d3.select("#main")
    // .on("touchstart", nozoom)
    // .on("touchmove", nozoom)
    .append("div")
    .classed("main",true)
    .attr("id", "treemap")
    .style("position", "relative")
    .style("width", (width + margin.left + margin.right) + "px")
    .style("height", (height + margin.top + margin.bottom) + "px")
    .style("left", margin.left + "px")
    .style("top", margin.top + "px");

var node;

// d3.json("test2.json", function(error, root) {
d3.json("flare.json", function(error, root) {
  if (error) throw error;
  // console.log(root)
  node = div.datum(root).selectAll(".node")
      .data(treemap.nodes)
    .enter().append("div")
      .attr("class", "node")
      .call(position)
      .style("background", function(d) { return d.children ? d3.rgb(color(d.name)).darker(.5) : color(d.parent.name); })
      .style("z-index", function(d){ return d.depth*100;})
      // .style("z-index", function(d){ return d.size+1; })
      // .style("box-shadow", function(d){ return d.children ? "inset 0 0 10px #222" : null;})
      // .text(function(d) { return d.children ? null : d.name; })
      // .text(function(d) { return d.name; })
      .html(function(d){ return d.children ? "<span style=\"opacity:0;\">"+d.name+"</span>" : d.name;})
      .attr("id", function(d){ return "nodeID_"+d.name; })
      .attr("depth", function(d){ if(d.depth > maxDepth) maxDepth = d.depth; return "d"+d.depth; })
      .attr("highlight", -1)
      // .call(drag)
      .on("mouseover", mouseEnter)
      .on("mouseout", mouseLeave)
      .on("click", mouseClick);
      
      var temp = d3.selectAll(".node");

      temp.forEach(function(e){ addForceTouchToElement(e); });
      
      
      // .on("click", detectShear);

      // console.log(d3.selectAll("[depth=d0]"));
  window.onresize = function(){
    treemap
      .size([document.getElementById("main").offsetWidth - margin.left - margin.right, window.innerHeight - margin.top - margin.bottom])
      .mode("slice-dice");
    node.data(treemap.nodes)
      .transition().ease("elastic")
      .duration(500)
      .call(position);
  }

  d3.selectAll("input").on("change", function change() {
    var value = this.value === "count" ? function() { return 1; } : function(d) { return d.size; };

    node.data(treemap.value(value).nodes)
      .transition()
      .duration(1500)
      .call(position);
  });

// d3.select("#main").on("click", function(){
//   alert("yup");
// });

// var columnData = d3.map()

// d3.selectAll(".node")[0].forEach(function(d) { console.log(d3.select(d).datum()); columnData.set(d3.select(d).datum().name, d3.select(d).datum().size); });
// console.log(columnData);
// var colExtent = d3.extent(columnData.values());
// console.log(colExtent)


// var color = d3.scale.linear()
//             .domain([0,colExtent[1]])
//             // .range(["rgb(224,236,244)", "rgb(77,0,75)"])
//             .range(["rgb(224,236,244)", "rgb(150,0,130)"])
//             .interpolate(d3.interpolateHcl);

// d3.selectAll(".node").style("background", function(d) { return d.children ? d3.rgb(color(12)).darker(.5) : color(d.size); });
  
  // d3.selectAll(".node").on("mouseover", mouseOvr);
});

function addForceTouchToElement(elem){
  elem.addEventListener("webkitmouseforcewillbegin", checkMacForce);
  elem.addEventListener("webkitmouseforcechanged", checkMacForce);
  elem.addEventListener("webkitmouseforcedown", enterForceClick);
  elem.addEventListener("webkitmouseforceup", exitForceClick);
}
// function mouseEnter(){
//   if(!d3.select(this).datum().children){
//     var hovered = d3.select(this);
//     d3.select(this)
//       .style("background", function(d){ return d3.rgb(color(d.parent.name)).brighter(.5);});
//     d3.select("#infoName").html(function(){ return "Name: <code>"+ hovered.datum().name +"</code>";})
//     d3.select("#infoSize").html(function(){ return "Size: <code>"+ hovered.datum().size +"</code>";})
//   }

// }

// function mouseLeave(){
//   if(!d3.select(this).datum().children){
//     d3.select(this)
//       .style("background", function(d){ return color(d.parent.name);});
//     // d3.select("#infoName").html(function(){ return "Name: ";})
//     // d3.select("#infoSize").html(function(){ return "Size: ";})
//   }
// }

// change the background to hover color, same as highlight color
function mouseEnter(){
  if(!d3.select(this).datum().children){
    var hovered = d3.select(this);
    d3.select(this)
      .style("background", function(d){ return d3.rgb(color(d.parent.name)).brighter(.5);});
    d3.select("#infoName").html(function(){ return "Name: <code>"+ hovered.datum().name +"</code>";})
    d3.select("#infoSize").html(function(){ return "Size: <code>"+ hovered.datum().size +"</code>";})
    d3.select("#infoParent").html(function(){ return "Size: <code>"+ hovered.datum().parent.name +"</code>";})
  }

}

// change the border and background back if not highlighted
function mouseLeave(){
  if(!d3.select(this).datum().children && d3.select(this).attr("highlight") == -1){
    d3.select(this)
      .style("background", function(d){ return color(d.parent.name);})
      // .style("background", "#ddd")
      .style("border", "solid 1px white");
    // d3.select("#infoName").html(function(){ return "Name: ";})
    // d3.select("#infoSize").html(function(){ return "Size: ";})
  }
}

// toggle the highlight value of the node, change the border
function mouseClick(){
  if(!d3.select(this).datum().children){
    var sel = d3.select(this);
    var highlight = -(sel.attr("highlight"));
    sel.attr("highlight", function(d){ return (highlight);})
      .style("border", function(d){
        if(highlight == 1) return "solid 3px white";
        else return "solid 1px white";
      });
  }
}

// d3.xml("data.xml", function(error, data){
//   if(error) throw error;

//   data = data.querySelectorAll("NODE");
//   console.log(data[0]);
//   // data = [].map.call(data.querySelectorAll("NODE"), function(node){
//   //   return {
//   //     name: +node.querySelector("NAME").textContent,
//   //     id: node.getAttribute("ID"),
//   //     frequency: +letter.querySelector("frequency").textContent
//   //   };
//   // });

// });

function position() {
  this.style("left", function(d) { return d.x + "px"; })
      .style("top", function(d) { return d.y + "px"; })
      .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
      .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
}

var drag = d3.behavior.drag()
    .origin(function(d) { return {x: d.x, y: d.y}; })
    .on("dragstart", dragstarted)
    .on("drag", dragged)
    .on("dragend", dragended);

var dragStartPos = [0,0];
var prevDrag = [-1,-1];

var dragPos = [0,0];

var touchNum = 0;

var curTime;
var prevTime = null;

var dragItem;
var wthis
var hthis
var area

var drillParent;

var drillTouch;

// var compMode, timedSelMode = false;
var compMode = true;
var hovering = 0;
var timedSelMode = false;
var shearingMode = false;
var dragDone = false;

var text = "Compare:";

var svg = d3.select("#svgLayer");

var prevComp;


var forceclick = false;

function enterForceClick(){
  console.log(forceclick);
  forceclick = true;
}

function exitForceClick(){
  console.log(forceclick);
  forceclick = false;
}

function dragstarted() {
  dragDone = false;
// calcEntropy("nodeID_1");

//// BEGIN - Compare with Ratio:
  // if(!d3.select(this).datum().children){
    curTime = Date.now();
    if(prevTime == null || prevTime < curTime-500) prevTime = curTime;
    if(prevTime >= curTime-500 && prevTime != curTime){
      //engageShearing behavior
      shearingMode = true;
      compMode = false;
      timedSelMode = false;
      // d3.selectAll(".node")
        // .classed("selection"+touchNum, true)
        // .style("z-index", function(d){ return d.depth; });
      clearTimeout(drillTouch);
      // treemap = d3.layout.treemap()
      //   .size([width, height])
      //   // .sticky(true)
      //   .padding(12)
      //   // .mode("slice-dice")
      //   .value(function(d) { return d.size; });

      // d3.selectAll(".node").forEach(function(d) {
      //   var value = function(d) {return d.size;}//this.value === "count" ? function() { return 1; } : function(d) { return d.size; };

      //   node.data(treemap.value(function(d) { return d.size; }).nodes)
      //     .transition()
      //     .duration(10)
      //     .call(position);
      // });
    }
    else{
      d3.selectAll(".node")
        .style("z-index", 0);
      clearTimeout(drillTouch);
    }

    dragStartPos = d3.mouse(d3.select("#main")[0][0])
    dragPos = dragStartPos;
    // dragStartPos[0]=d3.select(this).datum().x
    // dragStartPos[1]=d3.select(this).datum().y

  // if(dragStartPos[0]!=prevDrag[0] && dragStartPos[1]!=prevDrag[1]){
    //append the selected leaf node to the top of the DOM
    this.parentNode.appendChild(this);

    dragItem = d3.select(this)
    dragItem.classed("selection"+touchNum, true);
    // jk
    
    wthis = parseFloat(dragItem.style("width"));
    hthis = parseFloat(dragItem.style("height"));
    area = wthis*hthis;//

    // console.log(dragItem.attr("class"))

    prevDrag[0] = dragStartPos[0]
    prevDrag[1] = dragStartPos[1]
    
    // console.log(d3.select(this).datum().parent)
    var parent = dragItem.datum().parent.name;
    parent = "#nodeID_"+parent;

////////// MUST EXECUTE THIS SECION OF CODE IN DRILL DOWN PROCESS
    // //MOVE PARENT ELEMENT TO TOP OF DOM
    // d3.select("#"+parent).classed("selection"+touchNum, true)
    // document.getElementById(parent).parentNode.appendChild(document.getElementById(parent));

    // ///Add .selection[touchNum] class to all the children elements, and sort them to the top of the DOM
    // arrangeChildren(parent);
//////////

    // d3.selectAll(".selection"+touchNum).transition()
    d3.selectAll(".selection"+touchNum).transition()
      .ease("elastic")
      .duration(500)
      .styleTween("top", function(d,i) {
        // if(i == 0) 
        //   return d3.interpolate(d.y, d.y-24+"px");
        // else 
          return d3.interpolate(d.y, d.y-12+"px");
      })
      .styleTween("left", function(d,i) {
        if(i == 0) return d3.interpolate(d.x, d.x+"px");
      })
      .styleTween("box-shadow", function() { return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 4px 8px rgba(0,0,0,.4)"); })


    d3.select("#main").append("div")
      .classed("dragText", true)
      .style("position", "absolute")
      .style("left", dragItem.datum().x+margin.left-5+"px")
      .style("top", dragItem.datum().y+margin.top-12+"px")
      .html("<span id=\"compareText\" style=\"opacity:0;\">"+dragItem.datum().name+": "+dragItem.datum().size+"</span>")
      .style("width", "auto")
      .style("height", 0+"px")
      .style("padding-right", 10+"px")
      .style("border","solid 1px gray")
      .style("background", "rgba(255,255,255,0.8)")

    // d3.select("#compareText").style("opacity",0)

    .transition().duration(175)
      .style("top", dragItem.datum().y+margin.top-20-16+"px")
      .styleTween("opacity", function() { return d3.interpolate(0, 1); })
      .styleTween("box-shadow", function() { return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 2px 4px rgba(0,0,0,.2)"); })
      .style("height", 24+"px");

    svg.append("text")
      .classed("dragText", true)
      // .attr("id", tID)///////////////////Find out how to get the touch point from the array of touches?
      // .attr("touchID", touchID)
      .text(dragItem.datum().name+": "+dragItem.datum().size)
      .attr("x", dragItem.datum().x+margin.left)
      .attr("y", dragItem.datum().y+margin.top-16)
      // .attr("text-anchor", "middle")
      // .attr("fill", "blue")
      .transition().duration(300)
      .attr("y", dragItem.datum().y+margin.top-20)
      .styleTween("opacity", function() { return d3.interpolate(0, 1); })
  // }
  drillTouch = setTimeout(drillDown, 800);
  // touchNum++
////END - Compare with ratio

/*
////BEGIN - Timed Selection
  // dragStartPos = d3.mouse(d3.select("#main")[0][0])
  dragStartPos[0]=d3.select(this).datum().x
  dragStartPos[1]=d3.select(this).datum().y

  curTime = Date.now();

  // if(!d3.select(this).datum().children && (dragStartPos[0]!=prevDrag[0] && dragStartPos[1]!=prevDrag[1]) ){
  if(dragStartPos[0]!=prevDrag[0] && dragStartPos[1]!=prevDrag[1]){
    this.parentNode.appendChild(this);

    prevDrag[0] = dragStartPos[0]
    prevDrag[1] = dragStartPos[1]

    var parent = d3.select(this).datum().parent.name;
    parent = "nodeID_"+parent;

    //MOVE PARENT ELEMENT TO TOP OF DOM
    d3.select("#"+parent).classed("selection"+touchNum, true)
    document.getElementById(parent).parentNode.appendChild(document.getElementById(parent));

    /////NEED TO RECURSIVELY TRAVERSE DOWN INTO ALL THE CHILDREN (NEED TO REACH CHILDREN'S CHILDREN)
    arrangeChildren(parent);

    var y = d3.select("#"+parent).style("top");
    var sli = y.slice(0,y.length-2)

    d3.selectAll(".selection"+touchNum).transition()
        .ease("elastic")
        .duration(500)
        .styleTween("top", function(d,i) { 
          if(i == 0) return d3.interpolate(d.y, d.y-24+"px");
          else return d3.interpolate(d.y, d.y-12+"px");
        })
        .styleTween("left", function(d,i) {
          if(i == 0) return d3.interpolate(d.x, d.x+"px");
        })
        // .styleTween("box-shadow", function() { return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 4px 8px rgba(0,0,0,.4)"); })
  }
  dragItem = d3.select(this)
  drillTouch = setTimeout(drillDown, 500);
////END - Timed Selection



/* NEED to implement multitouch or a timed process in order to do shearing, possible to use double click
 * try to save reference to the clicked object and the time it was clicked, if that object was clicked a second time,
 * and the time passed was under a certain number of milliseconds, initiate shearing code.
////BEGIN - Shearing
  // dragStartPos = d3.mouse(this.parentNode.parentNode.parentNode)
  
  dragStartPos[0]=d3.select(this).datum().x
  dragStartPos[1]=d3.select(this).datum().y

  // if(!d3.select(this).datum().children && (dragStartPos[0]!=prevDrag[0] && dragStartPos[1]!=prevDrag[1])){

  if(dragStartPos[0]!=prevDrag[0] && dragStartPos[1]!=prevDrag[1]){

    prevDrag[0] = dragStartPos[0]
    prevDrag[1] = dragStartPos[1]

    d3.selectAll(".node").classed("selection"+touchNum, true)

    d3.selectAll(".selection"+touchNum).transition()
      .ease("elastic")
      .duration(500)
      .styleTween("top", function(d,i) { 
        // if(i == 0) 
        //   return d3.interpolate(d.y, d.y-24+"px");
        // else 
          return d3.interpolate(d.y, d.y-12+"px");
      })
      .styleTween("left", function(d,i) { 
        // if(i == 0) return d3.interpolate(d.x, d.x-12+"px");
        if(i == 0) return d3.interpolate(d.x, d.x+"px");
      })
      // .styleTween("box-shadow", function(d,i) { return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 "+(4+d.depth)+"px "+(4+d.depth*1.5)+"px rgba(0,0,0,"+(.4-d.depth*.05)+")"); })
      .styleTween("box-shadow", function(d,i) { if(i == 0) return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 4px "+8+"px rgba(0,0,0,.4)"); })
      
  }
  touchNum++;
////END - Shearing
*/
}

function dragged(d) {
  /*TO DO:
  *   Need to figure out why transitions on the dragItem are not working/are being canceled out by this function.
      Also, need to figure out why this function is being fired even when a drag is not happening, only a drag start.
  */
  
  // dragStartPos = d3.mouse(d3.select("#main")[0][0])
  dragPos = d3.mouse(d3.select("#main")[0][0])

  // dragPos[0] = d3.event.x;
  // dragPos[1] = d3.event.y;

  // console.log(dragPos+", "+prevDrag)
  
  // if((dragPos[0] >= prevDrag[0] || dragPos[0]-1 >= prevDrag[0]+14 || dragPos[1]-12 >= prevDrag[1]+14 || dragPos[1]-11 >= prevDrag[1]+14
  //   ||dragPos[0] <= prevDrag[0]-14 || dragPos[0]-1 <= prevDrag[0]-14 || dragPos[1]-12 <= prevDrag[1]-14 || dragPos[1]-11 <= prevDrag[1]-14)){
  // if((dragPos[0] != prevDrag[0] && dragPos[1] != prevDrag[1])){

  
  // console.log("here")
  if(compMode){
    if(!d.children){
      var xMove = d3.event.x;
      var yMove = d3.event.y;
      // console.log(xMove+", "+yMove)

      var mouse = d3.mouse(d3.select(".main")[0][0])
      // console.log(mouse)

      var dragName = dragItem.datum().name;
      var y = dragItem.datum().parent.y;

      var parent = dragItem.datum().parent.name;
      parent = "#nodeID_"+parent;

      // d3.select(this).transition("jhgjyhg").duration(0)//.transition("teasdast").duration(0)
      //     .style("left", function(d) { return xMove+"px"; })
      //     .style("top", function(d) { return yMove-12+"px"; })
      //     .style("box-shadow", "0 4px 8px rgba(0,0,0,.4)")

      // dragItem.style("box-shadow", "0 4px 8px rgba(0,0,0,.4)")


      // if(dragItem.style("opacity") != 0.75)
      //   dragItem.transition()
          // .styleTween("background", function() { return d3.interpolate(dragItem.style("background"), dragItem.style("background")+" .2");})
          // .styleTween("opacity", function() { return d3.interpolate(1, 0.75); });

          // .style("-webkit-transform", function(d) { return "translate(" + d[0] + "px," + d[1] + "px)"; });

      // svg.selectAll(".dragText").interrupt()
      //   .attr("x", function(){ if(this.tagName == "text") return xMove+margin.left; else return xMove+margin.left-5;})
      //   .attr("y", function(){ if(this.tagName == "text") return yMove+margin.top-20; else return yMove+margin.top-20-16;})
      //   .style("opacity", 1);

      var textLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "text";});
      var rectLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "rect";});
      var divLabel = d3.selectAll(".dragText").filter(function(){ return this.tagName == "DIV";});

      // svg.selectAll(".dragText").select("text").interrupt()
      textLabel.interrupt()
        .attr("x", xMove+margin.left)
        .attr("y", yMove+margin.top-20)
        .style("opacity", 1);

      rectLabel.interrupt()
        .attr("x", xMove+margin.left-5)
        .attr("y", yMove+margin.top-20-16)
        .attr("height", 24)
        .style("opacity", 1);

      divLabel.interrupt()
        .style("left", xMove+margin.left-5+"px")
        .style("top", yMove+margin.top-20-16+"px")
        .html("<span id=\"compareText\" style=\"opacity:0;\">"+textLabel.text()+"</span>")
        .style("width", "auto")
        .style("height", 24+"px")
        .style("padding-right", 10+"px")
        .style("border","solid 1px gray")
        .style("background", "rgba(255,255,255,0.8)")
        .style("box-shadow", "0 2px 4px rgba(0,0,0,.2)")
        .style("opacity", 1);

      d3.select("#compareText").style("opacity",0)

      var compare;
      var datum, left, top, dwidth, dheight

      d3.selectAll(".node")[0].forEach(function(d){
        if(!compare){
          datum = d3.select(d).datum();
          left = parseInt(d3.select(d).style("left"));
          top = parseInt(d3.select(d).style("top"));
          dwidth = Math.max(0, datum.dx - 1)
          dheight = Math.max(0, datum.dy - 1)

          if( (mouse[0] < left+dwidth) && (mouse[0] > left) && (mouse[1] < top+dheight) && (mouse[1] > top) && dragName!=datum.name && !datum.children){

            d3.selectAll(".compare")
              .classed("compare", false)
              .classed("old",true)
              .transition()
              .ease("elastic")
              .duration(300)
              .style("width", function(d){ return Math.max(0, d.dx - 1)+"px";})
              .style("height", function(d){ return Math.max(0, d.dy - 1)+"px";})
              // .style("background", function(d){return d3.rgb(color(d.parent.name));})
            // if(prevComp != compare){
              compare = d3.select(d);
              // prevComp = compare;
            // }
            compare.classed("compare", true).classed("old",false)
            d3.selectAll(".old").style("background", function(d){return d3.rgb(color(d.parent.name));})
          }
        }
      })

      if(compare){
        // function gcd (a, b) {
        //   return (b == 0) ? a : gcd (b, a%b);
        // }

        var a = dwidth, b = dheight, c;
        while(b!=0){
          c = a;
          a = b;
          b = c%b;
        }
        
        // console.log(a+", "+dwidth/a+":"+dheight/a+", "+dwidth/dheight)
        // var r = gcd(dwidth, dheight)
        // console.log(r+", "+dwidth/r+":"+dheight/r+", "+dwidth/dheight)
        // console.log(wthis+", "+hthis+", "+area)
        // console.log(dwidth*dheight)
        var scaler = (a*wthis*hthis)/(dwidth*dheight);
        if( (Math.sqrt(scaler)*(dwidth/a))*(Math.sqrt(scaler)*(dheight/a))< area-1 ){
          scaler = (a*a*wthis*hthis)/(dwidth*dheight);
        }
        // console.log(scaler+","+Math.sqrt(scaler)+","+(Math.sqrt(scaler)*(dwidth/a))*(Math.sqrt(scaler)*(dheight/a))+", "+area+"; "+dwidth+","+dheight+"; "+(dwidth*dheight)/a+"; "+area)

        // console.log("difference: "+dwidth/dheight+", "+wthis/hthis)
        // console.log( color(dragItem.datum().parent.name) )//dragItem.style("background")
        // console.log(d3.rgb(color(dragItem.datum().parent.name)).r+" "+d3.rgb(color(dragItem.datum().parent.name)).g+" "+d3.rgb(color(dragItem.datum().parent.name)).b+" .2")

        // hovering++;

        d3.select(this).interrupt()
          .style("left", function(d) { return xMove+"px"; })
          .style("top", function(d) { return yMove-12+"px"; })
          .style("box-shadow", "0 4px 8px rgba(0,0,0,.4)")
          .transition()
          .ease("elastic")
          .duration(500)
          .style("width", function(){if(prevComp != compare) return Math.sqrt(scaler)*(dwidth/a)+"px";})
          .style("height", function(){if(prevComp != compare) return Math.sqrt(scaler)*(dheight/a)+"px";})
          // .style("width", function(){ return Math.sqrt(wthis*hthis)+"px";})
          // .style("height", function(){ return Math.sqrt(wthis*hthis)+"px";})
          // .styleTween("opacity", function() { if(dragItem.style("opacity") != 0.75) return d3.interpolate(1, 0.75); })
          .styleTween("background", function() { var tmp = d3.rgb(color(dragItem.datum().parent.name)); 
            return d3.interpolate("rgba("+tmp.r+","+tmp.g+","+tmp.b, "rgba("+tmp.r+","+tmp.g+","+tmp.b+",.5)"); });
        
        compare
          // .transition()
          // .ease("elastic")
          // .duration(500)
          // .styleTween("background", function(d){ return d3.interpolate(d3.rgb(color(d.parent.name)),d3.rgb(color(d.parent.name)).brighter(.5)); })
          .style("background", function(d){return d3.rgb(color(d.parent.name)).brighter(.5);})

          // .style("width", function(){ return Math.sqrt(parseFloat(dwidth)*dheight)+"px";})
          // .style("height", function(){ return Math.sqrt(parseFloat(dwidth)*dheight)+"px";})

        // console.log(compare.datum().name);
        // d3.selectAll(".dragText")
        //   .text(dragItem.datum().name+": "+dragItem.datum().size+" vs. "+compare.datum().name+": "+compare.datum().size)
        textLabel.text(dragItem.datum().name+": "+dragItem.datum().size+" vs. "+compare.datum().name+": "+compare.datum().size)
        divLabel.html("<span id=\"compareText\" style=\"opacity:0;\">"+textLabel.text()+"</span>")

        // console.log(this);
        // console.log(compare[0][0]);
        compare[0][0].parentNode.appendChild(compare[0][0]);
        this.parentNode.appendChild(this);
      }
      else{
        d3.select(this).interrupt()
          .style("left", function(d) { return xMove+"px"; })
          .style("top", function(d) { return yMove-12+"px"; })
          .style("box-shadow", "0 4px 8px rgba(0,0,0,.4)")
        .transition("kljasd")//.delay(500)
        .ease("elastic")
        .duration(500)
          .style("width", function(d){ return Math.max(0, d.dx - 1)+"px";})
          .style("height", function(d){ return Math.max(0, d.dy - 1)+"px";});
        // console.log(compare.datum().name);
        // d3.selectAll(".dragText")
        //   .text(dragItem.datum().name+": "+dragItem.datum().size)
        textLabel.text(dragItem.datum().name+": "+dragItem.datum().size)
        divLabel.html("<span id=\"compareText\" style=\"opacity:0;\">"+textLabel.text()+"</span>")
      }
    }
  }
  else if(timedSelMode){
    d3.select(".dragText").remove();
    if(!d.children){
      var xMove = d3.event.x;
      var yMove = d3.event.y;

      var y = d3.select(this).datum().parent.y;

      var parent = d3.select(this).datum().parent.name;
      parent = "#nodeID_"+parent;

      var selClass = d3.select(this).attr("class")
      selClass = "."+selClass.slice(5, selClass.length)

      d3.selectAll(selClass).interrupt()
          .style("left", function(d,i) {
            // if(i == 0)
            //   return xMove-(dragStartPos[0]-d.x+12)+"px";
            // else
              return xMove-(dragItem.datum().x-d.x)+"px";

              
          })
          .style("top", function(d,i) {
            if(i == 0)
              return yMove-(dragItem.datum().y-d.y+24)+"px";
            else
              return yMove-(dragItem.datum().y-d.y+12)+"px";
          })
          // .style("opacity",1);
      d3.selectAll(selClass)
        .html(function(d,i){ if(i == 0) return "<span style=\"color:white;opacity:1;\">"+d.name+"</span>";
          else return d.children ? "<span style=\"opacity:0;\">"+d.name+"</span>" : d.name;
        })
        .style("background", function(d) {
          if(!d.children) var tmp = d3.rgb(color(d.parent.name));
          else var tmp = d3.rgb(color(d.name)).darker(.5).darker(.5);
          return !d.children ? "rgba("+tmp.r+","+tmp.g+","+tmp.b+",.4)" : "rgba("+tmp.r+","+tmp.g+","+tmp.b+",.2)"; 
        });

      // if(!(d3.select(selClass).style("opacity") <= 0.35))
      //   d3.selectAll(selClass).transition()
      //     .styleTween("opacity", function() { return d3.interpolate(1, 0.34); });

      // console.log(d3.select(selClass).style("opacity"));
    }
  }
  else if(shearingMode){
    // 
    // NEED TO PLAY AROUND HERE!!!!!!!!!!!!!!
    // 
    d3.select(".dragText").remove();
    if(!d.children){
      var xMove = d3.event.x;
      var yMove = d3.event.y;

      // var y = d3.select(this).datum().parent.y;
      var x = d3.select(this).datum().x;
      var y = d3.select(this).datum().y;


      var parent = d3.select(this).datum().parent.name;
      parent = "#nodeID_"+parent;

      var selClass = d3.select(this).attr("class")
      selClass = "."+selClass.slice(5, selClass.length)

      var minDepth = 0;
      var tmpVal = 0;
      d3.selectAll(selClass).interrupt()
        .style("left", function(d,i) {
          // if(i == 0)
            // return ((xMove-(x-d.x))-d.x)+(d.depth*.1)+"px";
            // var tmp = d3.select(this).style("left").slice(0,d3.select(this).style("left").length-2);
          if(i==0) minDepth = d.depth;
          tmpVal = d.depth-minDepth-1;
          if(i==0) return d.x+"px";
          else return  d.children ? ((xMove-x)*d.depth*.3)+d.x+"px" : ((xMove-x)*d.depth*.3)+d.x+6+"px";
            // return ((xMove*(d.depth*.1))+d.x)+"px";
          // else
          //   return ((xMove*(d.depth*.1))+d.x)+"px";
        })
        .style("top", function(d,i) {
          // if(i == 0)
          //   return ((yMove*(d.depth*.1))-(y-d.y+24))+"px";
          // else
            // return ((yMove*(d.depth*.1))-(dragStartPos[1]-y-d.y+12))+"px";
          if(i==0) minDepth = d.depth;
          tmpVal = d.depth-minDepth-1;
          if(i==0) return d.y-24+"px";
          else return d.children ? ((yMove-y)*d.depth*.3)+d.y-12+"px" : ((yMove-y)*d.depth*.3)+d.y+"px";
                    //((yMove-y)*d.depth*.3)+
            // return i==0 ? ((yMove-y)*d.depth*.3)+d.y-24+"px" : ((yMove-y)*d.depth*.3)+d.y-12+6+(tmpVal*6)+"px";
        })

      d3.selectAll(selClass)//.transition()
        .style("width", function(d,i){ 
          if(i==0) minDepth = d.depth;
          tmpVal = d.depth-minDepth-1;
          // return d.children ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1)-12+"px";
          if(i==0) return d.children ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1)-12+"px";
          else return d.children ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1) <= 12 ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1) <= 24 ? "12px" : Math.max(0, d.dx - 1)-18+"px";
        })
        .style("height", function(d,i){ 
          if(i==0) minDepth = d.depth;
          tmpVal = d.depth-minDepth-1;
          if(i==0) return Math.max(0, d.dy - 1)+24+"px"; 
          else return d.children ? Math.max(0, d.dy - 1)+"px" : Math.max(0, d.dy - 1) <= 12 ? Math.max(0, d.dy - 1)+"px" : Math.max(0, d.dy - 1) <= 24 ? "12px" : Math.max(0, d.dy - 1)-18+"px";
        })
        // .style("box-shadow", function(d,i) { return "0 "+(4+d.depth*0.5)+"px "+(4+d.depth*1.5)+"px rgba(0,0,0,"+(.4-d.depth*.07)+")";})

      // treemap.padding(12)
      // d3.selectAll(".node").call(position);
      
      // if(d3.select(selClass).style("opacity") != 0.75)
      //   d3.selectAll(selClass).transition()
      //     .styleTween("opacity", function() { return d3.interpolate(1, 0.75); });
    }
  }

// }

}



function dragended() {
  dragDone = true;
  if(compMode){
  ////BEGIN - Compare with ratio:
  // if(!d3.select(this).datum().children){
    var parent = d3.select(this).datum().parent.name;
    parent = "#nodeID_"+parent;

    // console.log(d3.select(this).attr("class"))
    var selClass = d3.select(this).attr("class")
    selClass = "."+selClass.slice(5, selClass.length);

    d3.select(this).transition()
        .ease("elastic")
        .duration(700)
        // .style("margin-top", -radius0 + "px")
        // .style("margin-left", -radius0 + "px")
        // .style("width", radius0 * 2 + "px")
        // .style("height", radius0 * 2 + "px")
        .style("width", function(d){ return Math.max(0, d.dx - 1)+"px";})
        .style("height", function(d){ return Math.max(0, d.dy - 1)+"px";})
        // .style("border-radius", radius0 + "px")
        .style("left", function(d) { return d.x+"px"; })
        .style("top", function(d) { return d.y+"px"; })
        // .style("-webkit-transform", function(d) { return "translate(" + 0 + "px," + 0 + "px)"; })
        .styleTween("box-shadow", function() { return d3.interpolate("0 4px 8px rgba(0,0,0,.4)", "0 0px 0px rgba(0,0,0,0)"); })
        .styleTween("opacity", function() { return d3.interpolate(0.75, 1); })
        .styleTween("background", function() { return d3.interpolate("rgba("+d3.rgb(color(dragItem.datum().parent.name)).r+","+d3.rgb(color(dragItem.datum().parent.name)).g+","+d3.rgb(color(dragItem.datum().parent.name)).b+",.5)", "rgba("+d3.rgb(color(dragItem.datum().parent.name)).r+","+d3.rgb(color(dragItem.datum().parent.name)).g+","+d3.rgb(color(dragItem.datum().parent.name)).b+",1)");});
    // }

    var textLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "text";});
    var rectLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "rect";});
    var divLabel = d3.selectAll(".dragText").filter(function(){ return this.tagName == "DIV";});

    textLabel.transition().duration(200)
      .attr("y", parseInt(dragItem.style("top"))+margin.top)
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    rectLabel.transition().duration(200)
      .attr("y", parseInt(dragItem.style("top"))+margin.top-20)
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    divLabel.transition().duration(200)
      .styleTween("top", function(){ return d3.interpolate(parseInt(dragItem.style("top"))+margin.top-24+"px", parseInt(dragItem.style("top"))+margin.top-16+"px");})
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    // d3.selectAll(".dragText").remove();

    d3.selectAll(".compare")
      .classed("compare", false)
      .transition()
      .ease("elastic")
      .duration(700)
      .style("width", function(d){ return Math.max(0, d.dx - 1)+"px";})
      .style("height", function(d){ return Math.max(0, d.dy - 1)+"px";})
      .style("background", function(d){return d3.rgb(color(d.parent.name));})
      // .attr("class", ".node")

    d3.selectAll(selClass).classed(selClass.slice(1,selClass.length), false)

    // hovering = 0;

  }
  else if(timedSelMode){
    if(!d3.select(this).datum().children){


    var parent = d3.select(this).datum().parent.name;
    parent = "#nodeID_"+parent;

    var selClass = d3.select(this).attr("class")
    selClass = "."+selClass.slice(5, selClass.length);

    d3.selectAll(selClass).transition()
        .ease("elastic")
        .duration(700)
        .style("left", function(d) { return d.x+"px"; })
        .style("top", function(d) { return d.y+"px"; })
        .style("height", function(d,i) {
          return Math.max(0, d.dy - 1)+ "px";
        })
        .styleTween("box-shadow", function(d,i) { if(i == 0) return d3.interpolate("0 4px 8px rgba(0,0,0,.4)", "0 0px 0px rgba(0,0,0,0)"); })
    // if(d3.select(selClass).style("opacity") != 0.75)
    //     d3.selectAll(selClass).transition()
    //       .styleTween("opacity", function() { return d3.interpolate(0.75, 1); });

        .style("opacity", 1);
        // .styleTween("height", function(d,i) { 
        //   if(i == 0){
        //     var height = d3.select("#nodeID_"+d.name).style("height")
        //     var tmp = height.slice(0, height.length-2);
        //     return d3.interpolate(parseInt(tmp)+"px", parseInt(tmp)-24+"px");} 
        // })
        // .styleTween("width", function(d,i) { 
        //   if(i == 0){
        //     var width = d3.select("#nodeID_"+d.name).style("width")
        //     var tmp = width.slice(0, width.length-2);
        //     return d3.interpolate(parseInt(tmp)+"px", parseInt(tmp)-24+"px");
        //   }
        // });
    d3.selectAll(selClass)
      .style("background", function(d) { 
        if(!d.children) return d3.rgb(color(d.parent.name));
        else return d3.rgb(color(d.name)).darker(.5);
      })

    d3.selectAll(selClass).classed(selClass.slice(1,selClass.length), false)
    // console.log(d3.select(this).attr("class"))

    var textLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "text";});
    var rectLabel = svg.selectAll(".dragText").filter(function(){ return this.tagName == "rect";});
    var divLabel = d3.selectAll(".dragText").filter(function(){ return this.tagName == "DIV";});

    textLabel.transition().duration(200)
      .attr("y", parseInt(dragItem.style("top"))+margin.top)
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    rectLabel.transition().duration(200)
      .attr("y", parseInt(dragItem.style("top"))+margin.top-20)
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    divLabel.transition().duration(200)
      .styleTween("top", function(){ return d3.interpolate(parseInt(dragItem.style("top"))+margin.top-24+"px", parseInt(dragItem.style("top"))+margin.top-16+"px");})
      .styleTween("opacity", function(){ return d3.interpolate(1,0);})
      .remove();

    prevDrag = [-1,-1]
    drillParent = false;
    timedSelMode = false;
    compMode = true;
    // clearTimeout(drillDown);
    }
  }
  else if(shearingMode){
    if(!d3.select(this).datum().children){
      var parent = d3.select(this).datum().parent.name;
      parent = "#nodeID_"+parent;

      var selClass = d3.select(this).attr("class")
      selClass = "."+selClass.slice(5, selClass.length);

      d3.selectAll(selClass)
          .style("background", function(d) { 
            if(!d.children) return d3.rgb(color(d.parent.name));
            else return d3.rgb(color(d.name)).darker(.5);
          })
        .transition()
          .ease("elastic")
          .duration(700)
          .style("left", function(d) { return d.x+"px"; })
          .style("top", function(d) { return d.y+"px"; })
          .style("width", function(d){ return Math.max(0, d.dx - 1) + "px";})
          .style("height", function(d){ return Math.max(0, d.dy - 1) + "px";})
          .styleTween("box-shadow", function(d,i) { return d3.interpolate("0 "+(4+d.depth)+"px "+(4+d.depth*1.5)+"px rgba(0,0,0,"+(.4-d.depth*.05)+")", "0 0px 0px rgba(0,0,0,0)"); })
          // .styleTween("box-shadow", function(d,i) { if(i == 0) return d3.interpolate("0 4px "+8+"px rgba(0,0,0,.4)", "0 0px 0px rgba(0,0,0,0)"); })
          // .styleTween("opacity", function() { if(d3.select(this).style("opacity") != 1) return d3.interpolate(0.75, 1); });

      d3.selectAll(selClass).classed(selClass.slice(1,selClass.length), false)
      prevDrag = [-1,-1]

      shearingMode = false;
      drillParent = false;
      compMode = true;
      prevTime = null;
    }
  }
  d3.selectAll(".node")
    .style("z-index", 0);

  clearTimeout(drillTouch);
}

function drillDown(){
  // var dragPos = [0,0];
  // dragPos = d3.mouse(d3.select("#main")[0][0])
  // dragPos[0] = parseInt(dragItem.style("left"))
  // dragPos[1] = parseInt(dragItem.style("top"))+12

  console.log(prevDrag+", "+dragPos)
  
  if(curTime<Date.now() && !(dragPos[0] >= prevDrag[0]+5 || dragPos[1] >= prevDrag[1]+5
                          || dragPos[0] <= prevDrag[0]-5 || dragPos[1] <= prevDrag[1]-5) && !dragDone ){
    if(!shearingMode) timedSelMode = true;
    compMode = false;
    curTime = Date.now();

    dragItem.interrupt().style("box-shadow", "")

    // prevDrag[0] = dragStartPos[0]
    // prevDrag[1] = dragStartPos[1]
    if(drillParent){
      drillParent = drillParent.parent
    }
    else{
      drillParent = dragItem.datum().parent;
    }
    var parent = drillParent.name;
    parent = "nodeID_"+parent;

    //MOVE PARENT ELEMENT TO TOP OF DOM
    d3.select("#"+parent).classed("selection"+touchNum, true)
    document.getElementById(parent).parentNode.appendChild(document.getElementById(parent));

    /////NEED TO RECURSIVELY TRAVERSE DOWN INTO ALL THE CHILDREN (NEED TO REACH CHILDREN'S CHILDREN)
    arrangeChildren(parent);

    var y = d3.select("#"+parent).style("top");
    var sli = y.slice(0,y.length-2)

    var minDepth = 0;
    var tmpVal = 0;

    console.log(d3.selectAll(".selection"+touchNum))
    d3.selectAll(".selection"+touchNum)
        .html(function(d,i){ return d.children ? "<span style=\"color:white;opacity:1;\">"+d.name+"</span>" : d.name;})
        .style("z-index", function(d){ return d.depth; })
        .transition()
        .ease("elastic")
        .duration(500)
        .style("left", function(d,i) {
          if(shearingMode){
            if(i==0) minDepth = d.depth;
            tmpVal = d.depth-minDepth-1;
            if(i==0) return d.x+"px";
            else return  d.children ? d.x+"px" : d.x+6+"px";
          }
          else{
            console.log("here");
            return d.x+"px";  
          }
        })
        .style("top", function(d,i) {
          if(shearingMode){
            if(i==0) minDepth = d.depth;
            tmpVal = d.depth-minDepth-1;
            if(i==0) return d.y-24+"px";
            else return d.children ? d.y-12+"px" : d.y+"px";
          }
          else{
            if(i == 0) return d.y-24+"px";
            else return d.y-12+"px";
          }
        })
        .style("width", function(d,i){
          if(shearingMode){
            if(i==0) minDepth = d.depth;
            tmpVal = d.depth-minDepth-1;
            if(i==0) return d.children ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1)-12+"px";
            else return d.children ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1) <= 12 ? Math.max(0, d.dx - 1)+"px" : Math.max(0, d.dx - 1) <= 24 ? "12px" : Math.max(0, d.dx - 1)-18+"px";
          }
          else{
            return Math.max(0, d.dx - 1)+ "px";
          }
        })
        .style("height", function(d,i){
          if(shearingMode){
            if(i==0) minDepth = d.depth;
            tmpVal = d.depth-minDepth-1;
            if(i==0) return Math.max(0, d.dy - 1)+24+"px"; 
            // else return d.children ? Math.max(0, d.dy - 1)+"px" : Math.max(0, d.dy - 1)-18+"px";
            else return d.children ? Math.max(0, d.dy - 1)+"px" : Math.max(0, d.dy - 1) <= 12 ? Math.max(0, d.dy - 1)+"px" : Math.max(0, d.dy - 1) <= 24 ? "12px" : Math.max(0, d.dy - 1)-18+"px";
          }
          else{
            if(i == 0) return Math.max(0, d.dy - 1)+12+ "px"
            else return Math.max(0, d.dy - 1)+ "px";
          }
        })
        .styleTween("box-shadow", function(d,i) {
          if(i == 0) return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 4px 8px rgba(0,0,0,.4)");
        })
        // .styleTween("box-shadow", function() { return d3.interpolate("0 0px 0px rgba(0,0,0,0)", "0 4px 8px rgba(0,0,0,.4)"); })
    drillTouch = setTimeout(drillDown, 800)

  }
  // else{
  //   clearInterval(drillTouch);
  // }
}

function arrangeChildren(parent){
  d3.select("#"+parent).datum().children.forEach(function(d,i){ 
    // console.log("child" + i+ ", "+ d.name)
    // console.log(document.getElementById("nodeID_"+d.name))
    document.getElementById("nodeID_"+d.name).parentNode.appendChild(document.getElementById("nodeID_"+d.name));
    d3.select("#nodeID_"+d.name).classed("selection"+touchNum, true)
    if(d.children){
      var tmp = "nodeID_"+d.name
      arrangeChildren(tmp)
    }

  ;})
}

function nozoom() {
  if(d3.touches(this).length == 1){
    d3.event.preventDefault();
  }
}
var W_total = 680;

var entropyTotal = 0;

function calcEntropy(parent){
  //need to calculate the entropy level of every subtree, and then only display the subtrees that are below the specified level.
  d3.select("#"+parent).datum().children.forEach(function(d,i){

    console.log(entropyTotal);
    // console.log("child" + i+ ", "+ d.name)
    // console.log(document.getElementById("nodeID_"+d.name))
    // document.getElementById("nodeID_"+d.name).parentNode.appendChild(document.getElementById("nodeID_"+d.name));
    entropyTotal += -(d.size/W_total)*Math.log(d.size/W_total)

    // d3.select("#nodeID_"+d.name).classed("selection"+touchNum, true)
    if(d.children){
      var tmp = "nodeID_"+d.name
      calcEntropy(tmp)
    }
  ;})
}
// var a = d3.selectAll(".node");
// window.onresize = a[0].forEach(position);

// calcEntropy("nodeID_1");
// console.log(entropyTotal);

</script>

</html>